<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; script-src 'self'; style-src 'self'; worker-src 'self' blob:;">
  <title>CSP Compliance Test - @native-select/core</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h1 {
      margin-top: 0;
      color: #333;
    }
    
    h2 {
      color: #666;
      border-bottom: 2px solid #0066cc;
      padding-bottom: 8px;
    }
    
    .status {
      padding: 12px;
      border-radius: 4px;
      margin: 16px 0;
      font-weight: 500;
    }
    
    .status.pass {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.fail {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.warn {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .test-item {
      display: flex;
      align-items: center;
      padding: 8px;
      margin: 4px 0;
    }
    
    .test-item::before {
      content: '‚úì';
      display: inline-block;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      border-radius: 50%;
      margin-right: 12px;
      font-weight: bold;
    }
    
    .test-item.pass::before {
      background: #28a745;
      color: white;
    }
    
    .test-item.fail::before {
      content: '‚úó';
      background: #dc3545;
      color: white;
    }
    
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    
    pre {
      background: #f4f4f4;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
    }
    
    native-select {
      margin: 16px 0;
    }
    
    .console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 16px;
    }
    
    .console-output div {
      margin: 4px 0;
    }
    
    .console-output .error {
      color: #f48771;
    }
    
    .console-output .warn {
      color: #dcdcaa;
    }
    
    .console-output .info {
      color: #4fc1ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîí CSP Compliance Test</h1>
    <p>This page tests <code>@native-select/core</code> in a CSP-restricted environment.</p>
    
    <div id="csp-status" class="status warn">
      ‚è≥ Running CSP compliance checks...
    </div>
  </div>

  <div class="container">
    <h2>Test 1: Basic Component Rendering</h2>
    <p>Component should render without CSP violations.</p>
    <native-select id="test-basic"></native-select>
    <div id="test1-result"></div>
  </div>

  <div class="container">
    <h2>Test 2: No eval/Function Usage</h2>
    <p>Component should not use <code>eval()</code> or <code>Function()</code> constructor.</p>
    <div id="test2-result"></div>
  </div>

  <div class="container">
    <h2>Test 3: No Inline Styles</h2>
    <p>Component should use only CSS classes and custom properties.</p>
    <native-select id="test-styles"></native-select>
    <div id="test3-result"></div>
  </div>

  <div class="container">
    <h2>Test 4: Worker Fallback</h2>
    <p>Component should work even if workers are blocked.</p>
    <div id="test4-result"></div>
  </div>

  <div class="container">
    <h2>Test 5: Shadow DOM Isolation</h2>
    <p>Styles should be encapsulated in shadow DOM.</p>
    <native-select id="test-shadow"></native-select>
    <div id="test5-result"></div>
  </div>

  <div class="container">
    <h2>Console Output</h2>
    <div id="console-output" class="console-output">
      <div class="info">Console ready. Checking for CSP violations...</div>
    </div>
  </div>

  <script type="module">
    // Capture console output
    const consoleOutput = document.getElementById('console-output');
    const originalConsole = {
      log: console.log,
      warn: console.warn,
      error: console.error
    };
    
    function addConsoleMessage(type, ...args) {
      const div = document.createElement('div');
      div.className = type;
      div.textContent = `[${type.toUpperCase()}] ${args.join(' ')}`;
      consoleOutput.appendChild(div);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }
    
    console.log = (...args) => { originalConsole.log(...args); addConsoleMessage('info', ...args); };
    console.warn = (...args) => { originalConsole.warn(...args); addConsoleMessage('warn', ...args); };
    console.error = (...args) => { originalConsole.error(...args); addConsoleMessage('error', ...args); };

    // Track CSP violations
    let cspViolations = [];
    document.addEventListener('securitypolicyviolation', (e) => {
      cspViolations.push(e);
      console.error('CSP Violation:', e.violatedDirective, e.blockedURI);
    });

    // Test suite
    const tests = {
      pass: 0,
      fail: 0,
      total: 0
    };

    function reportTest(elementId, passed, message) {
      tests.total++;
      if (passed) tests.pass++;
      else tests.fail++;
      
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="test-item ${passed ? 'pass' : 'fail'}">${message}</div>`;
    }

    async function runTests() {
      console.log('Starting CSP compliance tests...');

      // Test 1: Basic rendering
      try {
        const select = document.getElementById('test-basic');
        select.items = Array.from({ length: 100 }, (_, i) => ({ label: `Item ${i}` }));
        
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const hasItems = select.items.length === 100;
        const hasShadow = select.shadowRoot !== null;
        
        reportTest('test1-result', hasItems && hasShadow, 
          `Component rendered ${select.items.length} items with shadow DOM`);
      } catch (err) {
        reportTest('test1-result', false, `Error: ${err.message}`);
      }

      // Test 2: No eval/Function
      try {
        // Check if CSP blocks eval
        let evalBlocked = false;
        try {
          eval('1 + 1');
        } catch {
          evalBlocked = true;
        }
        
        let functionBlocked = false;
        try {
          new Function('return 1');
        } catch {
          functionBlocked = true;
        }
        
        reportTest('test2-result', evalBlocked && functionBlocked,
          `eval() blocked: ${evalBlocked}, Function() blocked: ${functionBlocked}`);
      } catch (err) {
        reportTest('test2-result', false, `Error: ${err.message}`);
      }

      // Test 3: No inline styles
      try {
        const select = document.getElementById('test-styles');
        select.items = [{ label: 'Style Test' }];
        
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const item = select.shadowRoot?.querySelector('[data-selectable]');
        const hasInlineStyle = item?.getAttribute('style') !== null;
        
        reportTest('test3-result', !hasInlineStyle,
          `Inline styles used: ${hasInlineStyle ? 'YES (FAIL)' : 'NO (PASS)'}`);
      } catch (err) {
        reportTest('test3-result', false, `Error: ${err.message}`);
      }

      // Test 4: Worker fallback
      try {
        // Component should work regardless of worker availability
        const select = document.getElementById('test-basic');
        const working = select.items.length > 0;
        
        reportTest('test4-result', working,
          `Component functional: ${working ? 'YES' : 'NO'}`);
      } catch (err) {
        reportTest('test4-result', false, `Error: ${err.message}`);
      }

      // Test 5: Shadow DOM
      try {
        const select = document.getElementById('test-shadow');
        select.items = [{ label: 'Shadow Test' }];
        
        const hasShadow = select.shadowRoot !== null;
        const hasStyles = select.shadowRoot?.querySelector('style') !== null;
        
        reportTest('test5-result', hasShadow && hasStyles,
          `Shadow DOM: ${hasShadow ? 'YES' : 'NO'}, Has styles: ${hasStyles ? 'YES' : 'NO'}`);
      } catch (err) {
        reportTest('test5-result', false, `Error: ${err.message}`);
      }

      // Summary
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const statusEl = document.getElementById('csp-status');
      const allPassed = tests.fail === 0 && cspViolations.length === 0;
      
      if (allPassed) {
        statusEl.className = 'status pass';
        statusEl.innerHTML = `‚úÖ All tests passed! (${tests.pass}/${tests.total}) No CSP violations detected.`;
      } else {
        statusEl.className = 'status fail';
        statusEl.innerHTML = `‚ùå ${tests.fail} test(s) failed. ${cspViolations.length} CSP violation(s) detected.`;
      }
      
      console.log(`Tests: ${tests.pass}/${tests.total} passed`);
      console.log(`CSP violations: ${cspViolations.length}`);
    }

    // Wait for component to be defined
    if (customElements.get('native-select')) {
      runTests();
    } else {
      console.warn('native-select not registered. Import the component first.');
    }
  </script>
</body>
</html>
